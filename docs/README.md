## STIX conversion

The inputs and outputs are all coded into STIX 2.1 objects as follows...

### txt2detection marking definition

The following marking defintion ID is added to all `object_marking_refs` of STIX objects created by txt2detection.

https://raw.githubusercontent.com/muchdogesec/stix4doge/refs/heads/main/objects/marking-definition/txt2detection.json

#### AI creation mode

### Report SDO (`report`)

All files uploaded are represented as a unique [STIX Report SDO](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_n8bjzg1ysgdq) that take the following structure;

If AI mode;

```json
{
    "type": "report",
    "spec_version": "2.1",
    "id": "report--<UUID V4 GENERATED BY STIX2 LIBRARY OR USER ENTERED AT INPUT>",
    "created_by_ref": "identity--<IDENTITY OBJECT USED AT UPLOAD OR TXT2DETECTION IDENTIFY IF NON SET>",
    "created": "<ITEM INGEST DATE OR DATE SET AT UPLOAD>",
    "modified": "<ITEM INGEST DATE OR DATE SET AT UPLOAD>",
    "name": "<NAME ENTERED ON UPLOAD>",
    "description": "<FULL BODY OF TEXT FILE>",
    "published": "<ITEM INGEST DATE OR DATE SET AT UPLOAD>",
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET IN CLI>",
        "marking-definition--a4d70b75-6f4a-5d19-9137-da863edd33d7"
    ],
    "labels": [
        "<LABELS ADDED BY USER AT CLI>"
    ],
    "external_references": [
        {
            "description": "description_md5_hash",
            "external_id": "<MD5 HASH OF DESCRIPTION FIELD>"
        },
        {
            "ANY EXTERNAL REFS SET AT CLI / REFERENCE URLS"
        }
    ],
    "object_refs": [
        "<LIST OF ALL INDICATOR OBJECTS CREATED>"
    ]
}
```

### Indicator SDO (`indicator`)

For each detection rule produced by the AI (there could be more than one) an Indicator object is created as follows;

```json
{
    "type": "indicator",
    "spec_version": "2.1",
    "id": "indicator--<UUIDV4>",
    "created_by_ref": "<SAME AS REPORT OBJECT IDENTITY VALUE>",
    "created": "<SAME AS REPORT OBJECT CREATED VALUE>",
    "modified": "<SAME AS REPORT OBJECT MODIFIED VALUE>",
    "indicator_types": [
        "<AI TYPES>"
    ],
    "name": "<AI NAME>",
    "description": "<AI DESCRIPTION>",
    "pattern_type": "sigma",
    "pattern": "<DETECTION_RULE>",
    "labels": [
        "<LABELS ADDED BY USER VIA CLI>"
    ],
    "external_references": [
        {
            "ANY EXTERNAL REFS SET AT CLI / REFERENCE URLS"
        },
        {
            "source_name": "sigma-level",
            "description": "<LEVEL>"
        },
        {
            "source_name": "sigma-status",
            "description": "<STATUS>"
        },
        {
            "source_name": "sigma-license",
            "description": "<LICENSE>"
        },
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/techniques/<ID>",
            "external_id": "<ID>"
        },
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/tactics/<ID>",
            "external_id": "<ID>"
        },
        {
            "source_name": "cve",
            "url": "https://nvd.nist.gov/vuln/detail/<ID>",
            "external_id": "<ID>"
        }
    ],
    "valid_from": "<REPORT CREATED PROPERTY VALUE>",
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET AT CLI>",
        "marking-definition--a4d70b75-6f4a-5d19-9137-da863edd33d7"
    ]
}
```

The actual rule generated and placed inside the `pattern` property is structured as follows;

```yml
id: <GENERATED BY TXT2DETECTION -- USED IN INDICATOR>
name: <GENERATED BY AI>
date: <SAME AS REPORT OBJECT CREATED VALUE>
modified: <SAME AS REPORT OBJECT MODIFIED VALUE>
author: <SAME AS REPORT IDENTITY ID>
description: <GENERATED BY AI>
detection: <GENERATED BY AI>
logsource: <GENERATED BY AI>
falsepositives: 
    - <GENERATED BY AI>
status: <GENERATED BY AI>
level: <GENERATED BY AI>
tags:
- tlp.<HUMAN READABLE TLP, SAME AS STIX OBJECTS>
- attack.<TECHNIQUE ID GENERATED BY AI>
- attack.<TACTIC ID GENERATED BY AI>
- cve.<CVE ID GENERATED BY AI>
- <LABELS ADDED BY USER AT CLI>
references:
    - <GENERATED BY AI>
    - <reference_urls ENTERED BY USER AT CLI>
```

### MITRE ATT&CK lookup 

Where MITRE ATT&CK Enterprise tactics/techniques detected, they are added to the bundle and joined to the Indicator object containing the detection.

For techniques;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "<SAME AS REPORT OBJECT IDENTITY VALUE>",
    "created": "<SAME AS REPORT OBJECT CREATED VALUE>",
    "modified": "<SAME AS REPORT MODIFIED CREATED VALUE>",
    "relationship_type": "detects",
    "description": "<INDICATOR NAME> detects <ATT&CK NAME>",
    "source_ref": "indicator--<ID>",
    "target_ref": "attack-pattern--<MITRE ATT&CK OBJECT ID>",
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET IN CLI>"
        "marking-definition--a4d70b75-6f4a-5d19-9137-da863edd33d7"
    ],
    "external_references": [
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/techniques/<ID>",
            "external_id": "<ID>"
        }
    ]
}
```

For tactics;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "<SAME AS REPORT OBJECT IDENTITY VALUE>",
    "created": "<SAME AS REPORT OBJECT CREATED VALUE>",
    "modified": "<SAME AS REPORT MODIFIED CREATED VALUE>",
    "relationship_type": "detects",
    "description": "<INDICATOR NAME> detects <ATT&CK NAME>",
    "source_ref": "indicator--<ID>",
    "target_ref": "x-mitre-tactic--<MITRE ATT&CK OBJECT ID>",
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET IN CLI>"
        "marking-definition--a4d70b75-6f4a-5d19-9137-da863edd33d7"
    ],
    "external_references": [
        {
            "source_name": "mitre-attack",
            "url": "https://attack.mitre.org/tactics/<ID>",
            "external_id": "<ID>"
        }
    ]
}
```


The objects themselves are imported from CTI Butler defined in the `.env` file.

### CVE lookup 

Where CVE IDs are detected, they are added to the bundle and joined to the Indicator object containing the detection;

```json
{
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "<SAME AS REPORT OBJECT IDENTITY VALUE>",
    "created": "<SAME AS REPORT OBJECT CREATED VALUE>",
    "modified": "<SAME AS REPORT MODIFIED CREATED VALUE>",
    "relationship_type": "detects",
    "description": "<INDICATOR NAME> detects <CVE ID>",
    "source_ref": "indicator--<ID>",
    "target_ref": "vulnerability--<ID>",
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET IN CLI>"
        "marking-definition--a4d70b75-6f4a-5d19-9137-da863edd33d7"
    ],
    "external_references": [
        {
            "source_name": "cve",
            "url": "https://nvd.nist.gov/vuln/detail/<ID>",
            "external_id": "<ID>"
        }
    ]
}
```

The objects themselves are imported from Vulmatch defined in the `.env` file.

## Bundle (script output)

The output of txt2stix is a STIX bundle file.

This bundle takes the format;

```json
{
    "type": "bundle",
    "id": "bundle--<SAME AS REPORT UUID PART>",
    "objects": [
        "<ALL STIX JSON DEFAULT AND EXTRACTED OBJECTS>"
    ]
}
```

The objects include all SROs generated for the input.

The output filename of the bundle takes the format: `bundle--<ID>.json`
